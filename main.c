/**
 * @file main.c
 *
 * @author Bruno Macabeus, David Silva
 *
 * @version 0.1
 *
 * @copyright
 * Copyright (C) Parallax, Inc. 2012. All Rights MIT Licensed.
 *
 * @brief Faz o blend mode entre os dois mapas de pixels presentes nas variáveis mapPixelsDest e mapPixelsSour, e então
 * retorna o resultado na saída serial do PIC.
 *
 * O mapa de pixels não pode ter dimensões maiores que 30x30.
 * A configuração da saída serial foi planejada para funcionar na PIC Board PIC18F45550.
 * A saída será uma imagem PPM versão 6.
 *
 * Para preencher com dados mais facilmente as variáveis mapPixelsDest e mapPixelsSour, use o tratamentoStructPPM.
 * Ele gerará, com base numa imagem PPM 6, o vetor pronto para ser usado nessas variáveis.
 */

#include <p18f4550.h>
#include <delays.h>
#include <usart.h>
#include <stdio.h>

#pragma config PLLDIV	 = 5
#pragma config CPUDIV 	= OSC1_PLL2
#pragma config FOSC   	= HSPLL_HS
#pragma config WDT      = OFF   

/**
 * Mapa de pixels da imagem de destino.
 *
 * O mapa de pixels é uma array tridimensional de chars, com altura, largura e RGB.
 */
rom unsigned char mapPixelsDest[30][30][3] = {{{0,0,0},{0,0,0},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{0,0,0},{0,0,0}},{{0,0,0},{224,224,224},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{224,224,224},{0,0,0}},{{64,64,64},{160,160,160},{160,160,160},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},
{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{160,160,160},{160,160,160},{64,64,64}},{{64,64,64},{160,160,160},{128,128,128},{128,128,128},{128,128,128},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{128,128,128},{128,128,128},{128,128,128},{160,160,160},{64,64,64}},{{64,64,64},{160,160,160},{128,128,128},{128,128,128},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{128,128,128},{128,128,128},{160,160,160},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,224,224},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},
{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,224,224},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{160,160,160},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{32,64,192},{32,32,160},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{32,32,160},{32,64,192},{64,64,224},{96,96,224},{224,224,224},{224,224,224},{96,96,224},{64,64,224},{32,64,192},{32,32,160},{1,1,1},{1,1,1},
{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{224,224,224},{224,224,224},{96,96,224},{96,96,224},{32,64,192},{32,32,160},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{96,96,224},{96,96,224},{32,64,192},{32,32,160},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{96,96,224},{96,96,224},{32,64,192},
{32,32,160},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{96,96,224},{96,96,224},{32,64,192},{32,32,160},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{96,96,224},{96,96,224},{32,64,192},{32,32,160},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{224,224,224},{224,224,224},{96,96,224},{96,96,224},
{32,64,192},{32,32,160},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{32,32,160},{32,64,192},{64,64,224},{96,96,224},{224,224,224},{224,224,224},{96,96,224},{64,64,224},{32,64,192},{32,32,160},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{32,32,160},{32,64,192},{96,96,224},{96,96,224},{32,64,192},{32,32,160},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{224,160,0},{1,1,1},{1,1,1},{1,1,1},
{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{224,224,224},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,160,0},{224,224,224},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},{128,128,128},{160,160,160},{224,224,224},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{224,224,224},{160,160,160},{128,128,128},{128,128,128},{64,64,64}},{{64,64,64},{128,128,128},
{128,128,128},{128,128,128},{160,160,160},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{160,160,160},{128,128,128},{128,128,128},{128,128,128},{64,64,64}},{{1,1,1},{64,64,64},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{64,64,64},{160,160,160},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{160,160,160},{64,64,64},{160,160,160},{160,160,160},{160,160,160},{160,160,160},{224,0,0},{224,0,0},{128,128,128},{128,128,128},{128,128,128},{64,64,64},{1,1,1}},{{0,0,0},{1,1,1},{64,64,64},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},
{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{64,64,64},{1,1,1},{0,0,0}},{{0,0,0},{0,0,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{0,0,0},{0,0,0}},{{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{1,1,1},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{160,160,160},{160,160,160},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{160,160,160},{160,160,160},{128,128,128},{128,128,128},{128,128,128},{128,128,128},{1,1,1},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0}},{{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{64,64,64},{1,1,1},{1,1,1},{1,1,1},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0}},{{0,0,0},{0,0,0},{0,0,0},
{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{1,1,1},{64,64,64},{64,64,64},{128,128,128},{128,128,128},{160,160,160},{160,160,160},{128,128,128},{128,128,128},{64,64,64},{64,64,64},{1,1,1},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0}},{{0,0,0},{0,0,0},{0,0,0},{64,64,64},{64,64,64},{128,128,128},{128,128,128},{128,128,128},{160,160,160},{160,160,160},{160,160,160},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{224,224,224},{160,160,160},{160,160,160},{160,160,160},{128,128,128},{128,128,128},{128,128,128},{64,64,64},{64,64,64},{0,0,0},{0,0,0},{0,0,0}},{{0,0,0},{0,0,0},{0,0,0},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{1,1,1},{0,0,0},{0,0,0},{0,0,0}}};

/**
 * Mapa de pixels da imagem source.
 *
 * O mapa de pixels é uma array tridimensional de chars, com altura, largura e RGB.
 */
rom unsigned char mapPixelsSour[30][30][3] = {{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},
{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},
{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},
{32,32,189},{32,32,189},{255,255,255},{255,255,255}},{{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{74,74,255},{106,106,255},{106,106,255},{74,74,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{255,255,255}},{{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{74,74,255},{106,106,255},{255,255,255},{255,255,255},{106,106,255},{74,74,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{255,255,255}},{{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{106,106,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{106,106,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},
{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{255,255,255}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{106,106,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{106,106,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,32,189},{32,32,189}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{74,74,255},{106,106,255},{255,255,255},{255,255,255},{106,106,255},{74,74,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{74,74,255},{106,106,255},
{106,106,255},{74,74,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189}},{{32,74,222},{32,74,222},{32,74,222},
{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,74,222}},{{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,32,189},{32,32,189},
{32,32,189},{32,32,189},{32,74,222}},{{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{255,255,255}},{{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{74,74,255},{255,255,255}},{{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},
{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{255,255,255}},{{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},
{32,32,189},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{74,74,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,32,189},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,32,189},{32,74,222},{32,74,222},{32,74,222},{32,32,189},{32,32,189},{32,74,222},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{74,74,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},
{255,255,255},{255,255,255},{255,255,255},{106,148,189},{106,148,255},{32,32,189},{32,32,189},{32,74,222},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{74,74,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{106,148,255},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{74,74,255},{32,74,222},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}},{{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,32,189},{32,74,222},{32,74,222},{32,74,222},{189,222,255},
{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255}}};

// Variáveis
int widthImgDest = 30, heightImgDest = 30, widthImgSour = 30, heightImgSour = 30;
unsigned char pixelRGB[3]; ///< Variável buffer do resultado em cada pixel do blend alpha entre as duas imagens

// Protótipos das funções
void rgbToUSART();
void configuraPIC();
void configuraUSART();
void enviaNumANum(int num);
void cabecalhoPPM();
void alpha();

/**
 * Envia para a saída serial os três bytes da variável global pixelRGB.
 */
void rgbToUSART(){
	while(BusyUSART());
	putcUSART(pixelRGB[0]);
	while(BusyUSART());
	putcUSART(pixelRGB[1]);
	while(BusyUSART());
	putcUSART(pixelRGB[2]);
}

/**
 * Configura a pinagem do PIC.
 *
 * No caso, a nossa única configuração necessária é colocar para o primeiro pino de C ser como saída, para funcionar a serial.
 */
void configuraPIC(){
	TRISC = 0b10000000;
}

/**
 * Configra a saída serial do PIC.
 */
void configuraUSART(){
	OpenUSART(USART_TX_INT_OFF &
                USART_RX_INT_OFF &
                USART_ASYNCH_MODE &
                USART_EIGHT_BIT &
                USART_SYNC_SLAVE &
                USART_CONT_RX & 
                USART_BRGH_HIGH, 154);
}

/**
 * Envia para saída serial como ASCII o valor inteiro recebido como parâmetro.
 * @param num Valor inteiro da qual será enviado para a serial.
 */
void enviaNumANum(int num){
	int buffer[6],resto,j,i = 0;
	while(num > 0){
		resto = num%10;
		buffer[i] = resto;
		num /= 10;
		i++;
        if(i > 6) num = 0;
	}
	if(i > 6){
		while(BusyUSART()); 
		putrsUSART("Dimensoes nao suportadas");
	}
	else{
        for(j = i-1;j >= 0;j--){
			while(BusyUSART());
            putcUSART(buffer[j] + 48);
        }
	}
}

/**
 * Envia para a saída serial o cabeçalho do arquivo PPM, que estará nos conformes do nosso código.
 *
 * A versão do arquivo PPM adotada é a 6.
 */
void cabecalhoPPM(){
	while(BusyUSART());
	putcUSART(0x50);
	while(BusyUSART());
	putcUSART(0x36);
	while(BusyUSART());
	putcUSART(0x0A);
	while(BusyUSART());
	enviaNumANum(widthImgDest);
	while(BusyUSART());
	putcUSART(0x20);
	while(BusyUSART());
	enviaNumANum(heightImgDest);
	while(BusyUSART());
	putcUSART(0x0A);
	while(BusyUSART());
	enviaNumANum(255);
	while(BusyUSART());
	putcUSART(0x0A);
}

/**
 * Efetua o blend mode entre o mapa de pixel das duas imagens e envia para a saída serial o resultado
 * do mapa de pixels gerado
 */
void alpha() {
	int posX, posY;
    float ad = 0.5, as = 1;

    // Criação do cabeçalho da nova imagem. Source foi convencionado como tamanho da nova imagem.
	cabecalhoPPM();

    // Início da composição alpha
    for (posX = 0, posY = -1; posX != widthImgSour + 1 && posY != heightImgSour; posX++) {
        posX %= widthImgSour;
        if (posX == 0) {
            posY += 1;
        }
        if (widthImgDest > posX && heightImgDest > posY) {
            pixelRGB[0] = (char) (mapPixelsDest[posY][posX][0] * ad + mapPixelsSour[posY][posX][0] * as * (1 - ad));
            pixelRGB[1] = (char) (mapPixelsDest[posY][posX][1] * ad + mapPixelsSour[posY][posX][1] * as * (1 - ad));
            pixelRGB[2] = (char) (mapPixelsDest[posY][posX][2] * ad + mapPixelsSour[posY][posX][2] * as * (1 - ad));
			rgbToUSART();
        } else {
            pixelRGB[0] = mapPixelsSour[posY][posX][0];
            pixelRGB[1] = mapPixelsSour[posY][posX][1];
            pixelRGB[2] = mapPixelsSour[posY][posX][2];
			rgbToUSART();
        }
    }
}

void main(){
	configuraPIC();
	configuraUSART();

    Delay10KTCYx(255);
	Delay10KTCYx(255);
	Delay10KTCYx(255);
	Delay10KTCYx(255);

	alpha();

	while (1) {
	}
}
